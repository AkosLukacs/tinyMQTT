var MQTT=function(a,b){b=b||{};this.server=a;this.port=b.port||1883;this.username=b.username;this.password=b.password;this.connected=!1;this.emitter=!0;mq=this};function onData(a){var b=a.charCodeAt(0);if(3===b>>4){var c=a.charCodeAt(2)<<8|a.charCodeAt(3);a={topic:a.substr(4,c),message:a.substr(4+c,a.charCodeAt(1)-c),dup:(b&8)>>3,qos:(b&6)>>1,retain:b&1};mq.emit("message",a)}}function mqttStr(a){return String.fromCharCode(a.length>>8,a.length&255)+a}
function mqttPacket(a,b,c){return String.fromCharCode(a,b.length+c.length)+b+c}function mqttConnect(a){var b=0;a=mqttStr(a);mq.username&&mq.password&&(b|=mq.username?128:0,b|=mq.username&&mq.password?64:0,a+=mqttStr(mq.username)+mqttStr(mq.password));b=String.fromCharCode(parseInt(b.toString(16),16));return mqttPacket(16,mqttStr("MQTT")+"\u0004"+b+"\u00ff\u00ff",a)}
MQTT.prototype.connect=function(){var a=function(){clearInterval(b);client.write(mqttConnect(getSerial()));mq.emitter&&mq.emit("connected");mq.connected=!0;client.on("data",onData.bind(mq));client.on("end",function(){mq.emit("disconnected");mq.connected=!1})};mq.client&&(mq.emitter=!1);var b=setInterval(function(){client=require("net").connect({host:mq.server,port:mq.port},a);mq.client=client},5E3)};
MQTT.prototype.subscribe=function(a){mq.client.write(mqttPacket(130,String.fromCharCode(256,1),mqttStr(a)+String.fromCharCode(1)))};MQTT.prototype.publish=function(a,b){mq.connected&&(mq.client.write(mqttPacket(49,mqttStr(a),b)),mq.emit("published"))};MQTT.prototype.disconnect=function(){mq.client.write(String.fromCharCode(224)+"\x00")};exports.create=function(a,b){return new MQTT(a,b)};